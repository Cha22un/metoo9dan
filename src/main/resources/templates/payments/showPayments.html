<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org">
<div layout:fragment="content" class="container my-3">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha2/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css" rel="stylesheet">
    <!-- 차트관련 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <div class="row">
        <div th:replace="~{/test/testSidebar::sidebar}"></div> <!--테스트 사이드바 경로를 넣어놓음-->
        <div style="border: 1px solid black;" class="col-10"> <!--class에서 col-10은 빼면 안됨-->
            <div style="width: 500px !important;">
                <!-- 일단위 그래프 -->
                <canvas id="dailySalesChart" width="300" height="150"></canvas>
            </div>
            <div style="width: 500px !important;">
                <!-- 월단위 그래프 -->
                <canvas id="monthlySalesChart" width="300" height="150"></canvas>
            </div>


            <div class="container">
                <h1>매출 조회</h1>
                <form method="get" action="/payments/showPayments" class="mb-3" id="graphForm">
                <div class="row">
                        <div class="col-md-3"></div> <!-- 왼쪽 여백 -->
                        <div class="col-md-2">
                            <input type="text" id="startDate" name="startDate" class="form-control datepicker" />
                        </div>
                        <div class="col-md-1 mx-auto">
                            <div class="text-center">~</div>
                        </div>
                        <div class="col-md-2">
                            <input type="text" id="endDate" name="endDate" class="form-control datepicker" />
                        </div>
                        <div class="col-md-2">
                            <div class="form-check form-check-inline">
                                <input type="radio" name="view" value="daily" id="daily" class="form-check-input" checked />
                                <label for="daily" class="form-check-label">일단위</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input type="radio" name="view" value="month" id="month" class="form-check-input" />
                                <label for="month" class="form-check-label">월단위</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary" id="nado-sel">조회</button>
                        </div>
                    </div>
                </form>
                <div class="col-md-7">
                    <strong>
                        <p>매출 합계 : <span th:text="${#numbers.formatInteger(totalAmount, 0, 'COMMA') + ' 원,        건수 : ' + totalTransactionCount + ' 개'}"></span></p>
                    </strong>
                </div>
                <table class="table">
                    <thead>
                    <tr>
                        <th>일 / 월</th>
                        <th>건수</th>
                        <th>매출금액</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- 월별 조회-->
                    <tr th:each="data : ${paymentsPage.content}" th:unless="${view} != 'month'">
                        <td th:text="${data[0]}"></td>
                        <td th:text="${data[1]}"></td>
                        <td th:text="${#numbers.formatInteger(data[2], 0, 'COMMA')}"></td>
                    </tr>
                    <!-- "daily" 일별 조회 -->
                    <tr th:each="data : ${paymentsPage.content}" th:unless="${view} != 'daily'">
                        <td th:text="${#temporals.format(data[0]?.paymentDate,'yyyy-MM-dd')}"></td>
                        <td th:text="${data[1]}"></td>
                        <td th:text="${#numbers.formatInteger(data[2], 0, 'COMMA')}"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
                <!-- 페이지 네이션 처리 -->
                <div id="pagination">
                    <nav aria-label="Page navigation example">
                        <ul class="pagination justify-content-center">
                            <!-- 이전 페이지 링크 -->
                            <li class="page-item" th:classappend="${paymentsPage.pageable.pageNumber == 0} ? 'disabled'">
                                <a class="page-link" href="#" th:href="@{/payments/showPayments(page=${paymentsPage.pageable.pageNumber - 1}, startDate=${startDate}, endDate=${endDate}, view=${view})}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            <!-- 페이지 번호 링크 -->
                            <li class="page-item" th:classappend="${i - 1 == paymentsPage.pageable.pageNumber} ? 'disabled'" th:each="i : ${#numbers.sequence(startPage, endPage)}">
                                <a class="page-link" href="#" th:href="@{/payments/showPayments(page=${i - 1}, startDate=${startDate}, endDate=${endDate}, view=${view})}" th:text="${i}"></a>
                            </li>
                            <!-- 다음 페이지 링크 -->
                            <li class="page-item" th:classappend="${paymentsPage.totalPages == paymentsPage.pageable.pageNumber + 1} ? 'disabled'">
                                <a class="page-link" href="#" th:href="@{/payments/showPayments(page=${paymentsPage.pageable.pageNumber + 1}, startDate=${startDate}, endDate=${endDate}, view=${view})}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
        </div>
    </div>
    <script>// "조회" 버튼을 클릭할 때
// "조회" 버튼을 클릭할 때
$("#nado-sel").click(function(e) {
    e.preventDefault(); // 폼의 기본 동작 방지
    var startDate = $("#startDate").val();
    var endDate = $("#endDate").val();
    var view = $('input[name="view"]:checked').val();

    // 선택한 startDate와 endDate 값을 서버로 전송
    $.ajax({
        url: "/payments/showPayments",
        method: "GET",
        data: {
            startDate: startDate,
            endDate: endDate,
            view: view
        },
        success: function(data) {
            // 그래프 업데이트 함수 호출
            fetchGraphData(data.view);
        },
        error: function(error) {
            console.error("데이터 가져오기 실패: " + error);
        }
    });
});

$(document).ready(function() {
    // 초기 페이지 로드 시 "일별" 데이터로 그래프 생성
    fetchGraphData('daily');

    // 그래프 데이터 가져오기 및 업데이트하는 함수
    function fetchGraphData(view) {
        $.ajax({
            url: "/paymentsChart/showPayments",
            method: "GET",
            data: { view: view },
            success: function(data) {
                console.log('data', data);

                // 받아온 데이터
                var graphData = data.data;

                // 날짜를 레이블로 사용
                var labels = graphData.labels;

                // 매출 데이터
                var salesData = graphData.salesData;

                // 이전 차트 객체 파괴
                if (view === 'month' && window.monthlyChart) {
                    window.monthlyChart.destroy();
                } else if (view === 'daily' && window.dailyChart) {
                    window.dailyChart.destroy();
                }

                // 캔버스 요소 초기화
                var canvasId = (view === 'month') ? "monthlySalesChart" : "dailySalesChart";
                var canvas = document.getElementById(canvasId);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

                // 서버에서 받아온 데이터를 그래프 데이터로 설정
                var chartData = {
                    labels: data.labels,
                    datasets: [
                        {
                            label: "매출금액",
                            data: data.salesData,
                            backgroundColor: "rgba(75, 192, 192, 0.2)",
                            borderColor: "rgba(75, 192, 192, 1)",
                            borderWidth: 1
                        }
                    ]
                };

                // 새로운 차트 객체 생성 및 업데이트
                var ctx = canvas.getContext("2d");
                if (view === 'month') {
                    window.monthlyChart = new Chart(ctx, {
                        type: "bar",
                        data: chartData,
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                } else if (view === 'daily') {
                    window.dailyChart = new Chart(ctx, {
                        type: "bar",
                        data: chartData,
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            },
            error: function(error) {
                console.error("데이터 가져오기 실패: " + error);
            }
        });
    }
});

    </script>
  <!--  <script>
        $(document).ready(function() {
     // 초기 그래프 데이터를 서버에서 가져옵니다.
     fetchGraphData('daily'); // 또는 'monthly'로 변경 가능

     // 월별 또는 일별 데이터 가져오는 함수
     function fetchGraphData(view) {
         $.ajax({
             url: "/paymentsChart/showPayments",
             method: "GET",
             data: { view: view },
             success: function(data) {
                console.log('data',data)
                var data = data.data; // 받아온 데이터
                var labels = Object.keys(data); // 날짜를 레이블로 사용
                var salesData = labels.map(function(date) {
                    return data[date];
                });

                 // 서버에서 받아온 데이터를 그래프 데이터로 설정
                 var monthlyData = {
                     labels: data.labels,
                     datasets: [
                         {
                             label: "매출금액",
                             data: data.salesData,
                             backgroundColor: "rgba(75, 192, 192, 0.2)",
                             borderColor: "rgba(75, 192, 192, 1)",
                             borderWidth: 1
                         }
                     ]
                 };

                // 그래프 생성 및 업데이트
                var ctx = document.getElementById("monthlySalesChart").getContext("2d");
                var myChart = new Chart(ctx, {
                    type: "bar",
                    data: monthlyData,
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
             },
             error: function(error) {
                 console.error("데이터 가져오기 실패: " + error);
             }
         });
     }
 });

    </script>-->

    <script>
        $(document).ready(function() {
    // 월별 링크를 클릭할 때 상세 매출 내역을 로드합니다.
    $(".monthly-link").click(function(event) {
        event.preventDefault(); // 기본 링크 동작 방지

        var month = $(this).text(); // 클릭한 월의 텍스트를 가져옵니다.

        $.ajax({
            url: "/payments/showMonthlyDetails", // 상세 매출 내역을 가져올 컨트롤러 경로
            method: "POST",
            data: { month: month }, // 선택한 월을 매개변수로 전달
            success: function(data) {
                // 상세 매출 내역을 로드한 후 해당 내용을 화면에 표시합니다.
                $("#monthly-details-container").html(data);
            },
            error: function() {
                alert("상세 매출 내역을 불러오는 중 오류가 발생했습니다.");
            }
        });
    });
});
    </script>


        <script>
    // 페이지가 로드될 때 Datepicker 초기화
    document.addEventListener("DOMContentLoaded", function () {
        // 시작 날짜 선택 위젯
        $('#startDate').datepicker({
            format: 'yyyy-mm-dd',
            todayBtn: 'linked',
            clearBtn: true,
            autoclose: true
        });

        // 종료 날짜 선택 위젯
        $('#endDate').datepicker({
            format: 'yyyy-mm-dd',
            todayBtn: 'linked',
            clearBtn: true,
            autoclose: true
        });
    });

    </script>

</div>
</html>