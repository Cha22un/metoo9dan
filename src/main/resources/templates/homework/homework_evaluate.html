<!--이 파일을 복사하여 templates/본인기능폴더 하위에 추가하여 작업해주세요-->
<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org">
<div layout:fragment="content" class="container my-3">
    <link rel="stylesheet" href="/css/homework/homework_eval.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <div class="row">
        <!--<div th:replace="~{각페이지에맞는사이드바파일경로::sidebar}"></div>-->
        <div th:replace="~{/homework/baseSidebar::sidebar}" ></div>

        <div style="border: 1px solid black;" class="col-10"> <!--class에서 col-10은 빼면 안됨-->
            <!-- 맡은 기능 구현 하시면 됩니다! -->
            <div> <!-- 상단 / 숙제별 숙제 전송 리스트 -->
                <!-- 제목 드롭다운 -->
                <div style="width:20%; margin: 12px 20px;">
                    <div class="dropdown">
                        <select id="titleDropdown" class="form-select">
                            <option value="All" selected="selected">All</option>
                            <option th:each="title : ${titles}" th:value="${title}" th:text="${title}"></option>
                        </select>
                    </div>
                </div>

                <!-- 정렬 옵션 -->
                <div style="width:20%; margin: 12px 20px;">
                    <div class="dropdown">
                        <select id="sortOrder">
                            <option value="asc">오름차순</option>
                            <option value="desc">내림차순</option>
                        </select>
                    </div>
                </div>

                <!-- 숙제 전송 테이블 -->
                <table id="hwSendTable">
                    <!-- 여기에 결과가 들어갈 예정 -->
                </table>

                <!-- 페이지네이션 -->
                <div id="pagination">
                    <!-- 여기에 페이지네이션 내용이 들어갈 예정 -->
                </div>
            </div>
            <!-- 상단 끝 -->

            <!-- 하단 -->
            <div id="lowerSection" style="display:none;">
                <div>
                    <!-- 숙제 제출 / 평가 현황 미니 대시보드 -->
                </div>

                <div>
                    <!-- 전송 내역 -->
                    <form><!-- 숙제 평가 업데이트 폼 -->
                        <div id="evaluationCard"></div>
                        <div id="eval-pagination"></div>
                        <input type="submit">
                    </form>
                </div>
            </div>
            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <script>
                $(document).ready(function() {
                    //초기
                    loadTable(1);

                    // 드롭다운 변경 이벤트
                    $("#titleDropdown").on('change', function() {
                    console.log("제목 드롭다운 선택");
                        loadTable(1); // 선택 후 첫 페이지 로드
                    });

                    // 정렬 이벤트
                    $("#sortOrder").on('change', function() {
                    console.log("정렬 드롭다운 선택");
                        loadTable(1);
                    });

                    // 페이지네이션 클릭 이벤트
                    $(document).on('click', '.pagination-link', function(e) {
                        e.preventDefault();
                        let page = $(this).data('page');
                        loadTable(page);
                    });
                });

                // 상위 테이블 로드
                function loadTable(page = 1) {
                    let title = $("#titleDropdown").val();
                    let sortOrder = $("#sortOrder").val();
                    $.ajax({
                        url: '/homework/evaluate/hw-list',
                        type: 'GET',
                        data: {
                            title: title,
                            sort: sortOrder,
                            page: page
                        },
                        success: function(response) {
                            // 결과 테이블 갱신
                            let tableContent = '<thead><tr><th>제목</th><th>내용</th><th>진도</th><th>제출기한</th><th>전송일자</th></tr></thead><tbody>';
                                response.content.forEach(item => {
                                    tableContent += `
                                    <tr data-hw-id="${item.homeworkNo}" data-send-date="${item.sendDate}">
                                    <td>${item.homeworkTitle}</td>
                                    <td>${item.homeworkContentPreview}</td>
                                    <td>${item.currentLevel}</td>
                                    <td>${item.dueDate}</td>
                                    <td>${item.sendDate}</td>
                                    </tr>`;
                                });
                            tableContent += '</tbody>';
                            $('#hwSendTable').html(tableContent);


                            // 페이지네이션 갱신
                            let paginationContent = '';
                            let endPage = Math.ceil(page / 5.0) * 5;
                            let startPage = endPage - 4;

                            if (startPage > 1) {
                                paginationContent += `<a href="#" class="pagination-link" data-page="${startPage - 1}">이전</a>`;
                            }

                            for (let i = startPage; i <= endPage && i <= response.totalPages; i++) {
                                paginationContent += `<a href="#" class="pagination-link" data-page="${i}">${i}</a>`;
                            }

                            if (endPage < response.totalPages) {
                                paginationContent += `<a href="#" class="pagination-link" data-page="${endPage + 1}">다음</a>`;
                            }

                            $('#pagination').html(paginationContent);
                        }
                    });
                }

                // -----------------------------------------------------------------------------------
                let currentPageSub = 1;    // 하위 테이블의 현재 페이지

                $(document).ready(function() {
                    // 더블 클릭 이벤트 핸들러
                    $("#hwSendTable").on("dblclick", "tr", function() {
                    console.log($(this).data('hw-id'), $(this).data('send-date'));
                        // 숙제 번호와 sendDate를 가져온다 ->복합키로 검색 예정
                        var homeworkNo = $(this).data('hw-id');
                        var sendDate = $(this).data('send-date');

                        $.ajax({
                            url: '/homework/evaluate/submit-list',
                            type: 'GET',
                            data: {
                                homeworkNo: homeworkNo,
                                sendDate: sendDate,
                                page: currentPageSub  // 여기를 수정했습니다.
                            },
                            success: function(response) {
                            console.log(response.content);
                                // 결과 카드 갱신
                                let tableContent = '';
                                    response.content.forEach(item => {
                                        let currentDate = new Date();
                                        tableContent += `
                                            <div>
<div class="cute-card">
    <div class="item-row">
        <i class="fa fa-user"></i> <span>${item.name}</span>
    </div>
    <div class="item-row">
        <i class="fa fa-book"></i> <span>${item.homeworkTitle}</span>
    </div>
    <div class="item-row">
        <i class="fa fa-pencil"></i> <span>${item.homeworkContent}</span>
    </div>
    <div class="item-row">
        <i class="fa fa-gamepad"></i> <span>${item.gameTitle}</span>
    </div>
    <div class="item-row">
        <i class="fa fa-calendar"></i> <span>${item.dueDate}</span>
    </div>
    <div class="item-row">
        <i class="fa fa-paper-plane"></i> <span>${item.sendNo}</span>
    </div>
    <div class="item-row">
        <i class="fa fa-star"></i> <span>${item.currentLevel}</span>
    </div>
    <div class="item-row">
        <i class="fa fa-clock-o"></i> <span>${item.sendDate}</span>
    </div>
    <div class="item-row">
        <i class="fa fa-list"></i> <span>${item.homeworkNo}</span>
    </div>
<hr class="cute-hr"/>
                                        `;

                                        if(item.homeworkSubmitNo !== 0 && new Date(item.dueDate) < currentDate) {
                                            tableContent += `
                                               <div class="cute-card-submit">
    <div class="item-row">
        <i class="fa fa-list-ol"></i> <span>${item.homeworkSubmitNo}</span>
    </div>
    <div class="item-row">
        <i class="fa fa-eye"></i> <span>${item.submitContentPreview}</span>
    </div>
    <div class="item-row">
        <i class="fa fa-file-alt"></i> <span>${item.submitContent}</span>
    </div>
    <div class="item-row">
        <i class="fa fa-question-circle"></i> <span>${item.additionalQuestionsPreview}</span>
    </div>
    <div class="item-row">
        <i class="fa fa-comments"></i> <span>${item.additionalQuestions}</span>
    </div>
    <div class="item-row">
        <i class="fa fa-calendar-check"></i> <span>${item.submitDate}</span>
    </div>
    <div class="item-row">
        <i class="fa fa-star-half-alt"></i> <span>${item.evaluation}</span>
    </div>
<div class="dropdown cute-dropdown">
    <select id="evaluation${item.homeworkSubmitNo}" class="form-select">
        <option value="F" selected="selected">선택해주세요</option>
        <option value="A">우수</option>
        <option value="B">보통</option>
        <option value="C">미흡</option>
    </select>
</div>
</div>
                                            `;
                                        } else if(item.homeworkSubmitNo === 0 && new Date(item.dueDate) > currentDate) {
                                            tableContent += `
<div class="no-submission-wrapper">
    <div class="no-submission-message">제출된 숙제가 없습니다</div>
    <button class="cancel-btn" data-sendno="${item.sendNo}">전송 취소</button>
</div>
</div>

                                            `;
                                        } else if(item.homeworkSubmitNo !== 0 && new Date(item.dueDate) <= currentDate){
                                            tableContent += `
    <div class="item-row">
        <i class="fa fa-list-ol"></i> <span>${item.homeworkSubmitNo}</span>
    </div>
    <div class="item-row">
        <i class="fa fa-eye"></i> <span>${item.submitContentPreview}</span>
    </div>
    <div class="item-row">
        <i class="fa fa-file-alt"></i> <span>${item.submitContent}</span>
    </div>
    <div class="item-row">
        <i class="fa fa-question-circle"></i> <span>${item.additionalQuestionsPreview}</span>
    </div>
    <div class="item-row">
        <i class="fa fa-comments"></i> <span>${item.additionalQuestions}</span>
    </div>
    <div class="item-row">
        <i class="fa fa-calendar-check"></i> <span>${item.submitDate}</span>
    </div>
    <div class="item-row">
        <i class="fa fa-star-half-alt"></i> <span>${item.evaluation}</span>
    </div>
</div>
<div class="no-submission-wrapper">
    <div class="no-submission-message">아직 평가 기간이 되지 않았습니다</div>
</div>
</div>
                                            `;
                                        }

                                    });
                                $('#evaluationCard').html(tableContent);

                                // 페이지네이션 갱신
                                let paginationContent = '';
                                let endPage = Math.ceil((response.number + 1) / 5.0) * 5; // '+1'은 현재 페이지 번호가 0부터 시작하기 때문입니다.
                                let startPage = endPage - 4;

                                if (startPage > 1) {
                                    paginationContent += `<a href="#" class="pagination-link-sub" data-page="${startPage - 1}">이전</a>`;
                                }

                                for (let i = startPage; i <= endPage && i <= response.totalPages; i++) {
                                    if (i === response.number + 1) {
                                        paginationContent += `<span class="current-page">${i}</span>`; // 현재 페이지를 강조합니다.
                                    } else {
                                        paginationContent += `<a href="#" class="pagination-link-sub" data-page="${i}">${i}</a>`;
                                    }
                                }

                                if (endPage < response.totalPages) {
                                    paginationContent += `<a href="#" class="pagination-link-sub" data-page="${endPage + 1}">다음</a>`;
                                }

                                $('#eval-pagination').html(paginationContent);
                                $('#lowerSection').css("display", "block");
                            }
                        });
                        });
                    });
                    // 페이지네이션 링크 클릭 이벤트 핸들러
                    $(document).on("click", ".pagination-link-sub", function(e) {
                        e.preventDefault(); // 기본 링크 동작을 방지합니다.

                        currentPageSub = $(this).data('page'); // 클릭한 페이지 번호를 할당합니다.

                        // 더블 클릭 이벤트에서 사용한 로직을 재사용하여 데이터를 가져옵니다.
                        // 여기서는 가장 최근에 더블 클릭된 row의 데이터를 사용하게 됩니다.
                        // 이를 위해 선택된 row의 데이터를 전역 변수에 저장하는 방식으로 접근합니다.
                        var homeworkNo = $("#hwSendTable").find("tr.selected").data('hw-id');
                        var sendDate = $("#hwSendTable").find("tr.selected").data('send-date');

                        $.ajax({
                            url: '/homework/evaluate/hw-list',
                            type: 'GET',
                            data: {
                                homeworkNo: homeworkNo,
                                sendDate: sendDate,
                                page: currentPageSub
                            },
                            success: function(response) {
                            // 결과 카드 갱신
                                let tableContent = '';
                                    response.content.forEach(item => {
                                        let currentDate = new Date();
                                        tableContent += `
                                            <div>
                                                <div>
                                                    <span>${item.name}</span>
                                                    <span>${item.homeworkTitle}</span>
                                                    <span>${item.homeworkContent}</span>
                                                    <span>${item.gameTitle}</span>
                                                    <span>${item.dueDate}</span>
                                                    <span>${item.sendNo}</span>
                                                    <span>${item.currentLevel}</span>
                                                    <span>${item.sendDate}</span>
                                                    <span>${item.homeworkNo}</span>
                                                </div>
                                                <hr/>
                                        `;

                                        if(item.homeworkSubmitNo !== 0 && new Date(item.dueDate) < currentDate) {
                                            tableContent += `
                                                <div>
                                                    <span>${item.homeworkSubmitNo}</span>
                                                    <span>${item.submitContentPreview}</span>
                                                    <span>${item.submitContent}</span>
                                                    <span>${item.additionalQuestionsPreview}</span>
                                                    <span>${item.additionalQuestions}</span>
                                                    <span>${item.submitDate}</span>
                                                    <span>${item.evaluation}</span>
                                                </div>
                                                <div class="dropdown">
                                                    <select id="evaluation${item.homeworkSubmitNo}" class="form-select">
                                                        <option value="F" selected="selected">선택해주세요</option>
                                                        <option value="A">우수</option>
                                                        <option value="B">보통</option>
                                                        <option value="C">미흡</option>
                                                    </select>
                                                </div>
                                            `;
                                        } else if(item.homeworkSubmitNo === 0 && new Date(item.dueDate) > currentDate) {
                                            tableContent += `
                                                <div>제출된 숙제가 없습니다</div>
                                                <button>전송 취소</button>
                                            `;
                                        }

                                        tableContent += `
                                                <input type="submit">
                                            </div>
                                        `;
                                    });
                                $('#evaluationCard').html(tableContent);

                                // 페이지네이션 갱신
                                let paginationContent = '';
                                let endPage = Math.ceil((response.number + 1) / 5.0) * 5; // '+1'은 현재 페이지 번호가 0부터 시작하기 때문입니다.
                                let startPage = endPage - 4;

                                if (startPage > 1) {
                                    paginationContent += `<a href="#" class="pagination-link-sub" data-page="${startPage - 1}">이전</a>`;
                                }

                                for (let i = startPage; i <= endPage && i <= response.totalPages; i++) {
                                    if (i === response.number + 1) {
                                        paginationContent += `<span class="current-page">${i}</span>`; // 현재 페이지를 강조합니다.
                                    } else {
                                        paginationContent += `<a href="#" class="pagination-link-sub" data-page="${i}">${i}</a>`;
                                    }
                                }

                                if (endPage < response.totalPages) {
                                    paginationContent += `<a href="#" class="pagination-link-sub" data-page="${endPage + 1}">다음</a>`;
                                }

                                $('#eval-pagination').html(paginationContent);
                            }
                        });
                    });

                document.querySelector(".cancel-btn").addEventListener("click", function() {
                    var sendNo = this.getAttribute("data-sendno");

                    var confirmation = confirm("전송을 취소하시겠습니까?");

                    if (confirmation) {
                        fetch(`/homework/send/cancel/${sendNo}`, {
                            method: "DELETE",
                        }).then(response => response.json()).then(data => {
                            if (data.success) { // 예: 서버에서 { success: true } 라는 응답을 보냈다고 가정
                                alert("숙제가 성공적으로 삭제되었습니다.");
                                location.reload();
                            } else {
                                alert("숙제 삭제에 실패하였습니다. 다시 시도해주세요.");
                            }
                        });
                    }
                });

            </script>
        </div><!--콘텐츠영역끝-->
    </div><!--row-->
</div><!--container-->
</html>