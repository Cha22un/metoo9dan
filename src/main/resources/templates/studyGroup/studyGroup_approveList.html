<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org">
<div layout:fragment="content" class="container my-3">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <div class="row">
        <div th:replace="~{/studyGroup/testSidebar::sidebar}"></div> <!--테스트 사이드바 경로를 넣어놓음-->

        <div style="border: 1px solid black;" class="col-10"> <!--class에서 col-10은 빼면 안됨-->
            <!-- 맡은 기능 구현 하시면 됩니다! -->
            <p/>[학습 그룹 신청 리스트]
            <div>
                <p/>
                <!--<form th:object="${approvalForm}" method="post" action="/studygroup/updateApprove" id="approvalForm">-->
                <form id="approvalForm">
                    <table class="table">
                        <thead class="table-dark">
                        <tr>
                            <th>NO</th>
                            <th>학습 그룹명</th>
                            <th>학생 이름</th>
                            <th>학생 연락처</th>
                            <th>승인 요청 일자</th>
                            <th>승인 일자</th>
                            <th>승인 여부</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:if="${#lists.size(approveList) != 0}" th:each="approveList, idx :${approveList}">
                            <td th:text="(${idx.index + 1})"></td>
                            <td th:text="${approveList.group_name}"></td>
                            <td th:text="${approveList.name}"></td>
                            <td th:text="${approveList.tel}"></td>
                            <td th:text="${#dates.format(approveList.application_date,'yyyy-MM-dd')}"></td>
                            <td th:text="${#dates.format(approveList.approved_date,'yyyy-MM-dd')}"></td>
                            <td>
                                <input type="checkbox" class="groupCheckbox" name="selectedMembers" th:attr="data-group-students-no=${approveList.group_students_no}" th:checked="${approveList.is_approved}"/>
                            </td>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <button id="viewButton" type="submit">저장 하기</button>
                </form>
            </div>
            <p/>
        </div>
    </div>
</div>

</html>
<script type="text/javascript">

    $(document).ready(function() {
    var selectedMembers = []; // 선택된 멤버의 group_students_no를 저장할 배열

    // 클래스 'groupCheckbox'를 가진 체크박스의 변경 사항을 청취합니다.
    $('.groupCheckbox').change(function() {
        // is_approved와 group_students_no의 값을 가져옵니다.
        var isApproved = $(this).is(':checked');
        var groupStudentsNo = $(this).data('group-students-no'); // data 속성을 가져옴

       var index = selectedMembers.indexOf(parseInt(groupStudentsNo));
        if (index === -1) {
            selectedMembers.push(parseInt(groupStudentsNo)); // 배열에 추가
        } else {
            selectedMembers.splice(index, 1); // 배열에서 제거
        }

        // 숨겨진 입력 필드에 값을 설정 (체크 여부에 관계없이 항상 설정)
        var $groupStudentsNoInput = $(this).closest('td').find('.groupStudentsNo'); // 해당 체크박스와 연결된 숨겨진 입력 필드
        $groupStudentsNoInput.val(groupStudentsNo);
    });

    // '저장하기' 버튼 클릭 시 서버로 선택된 멤버의 group_students_no를 전송
    $('#viewButton').click(function(event) {
        event.preventDefault(); // 기본 이벤트 중지

        var data = {
            selectedMembers: selectedMembers
        };

        $.ajax({
            type: 'POST',
            url: '/studygroup/updateApprove',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                // 필요한 경우 서버 응답을 처리합니다.
                console.log('데이터 전송 성공');
                //데이터 전송 성공 후 페이지 리다이렉트
                window.location.href = '/studygroup/approveList';
            },
            error: function(xhr, status, error) {
                // AJAX 요청 중에 발생하는 오류를 처리합니다.
                console.error('데이터 전송 중 오류: ' + error);
            }
        });
    });
});


</script>
