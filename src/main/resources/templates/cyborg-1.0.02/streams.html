<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<div layout:fragment="content" class="container my-3">
  <link rel="stylesheet" href="/css/game/list.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <div class="row">
    <!--<div th:replace="~{각페이지에맞는사이드바파일경로::sidebar}"></div>-->
    <!--<div th:replace="~{/admin/adminSidebar::sidebar}"></div>--> <!--테스트 사이드바 경로를 넣어놓음-->
    <div class="col-2" >
    <ul>
      <li class="mt-5"><h4>구독서비스</h4></li>
      <hr>
      <li class="mb-3 p-2"><a th:href="@{/payments/alllist}" sec:authorize="hasAuthority('ADMIN')">게임콘텐츠 구매</a></li>
      <li class="mb-3 p-2"><a th:href="@{/game/list}" sec:authorize="hasAuthority('ADMIN')">게임콘텐츠 조회</a></li>
    </ul>
  </div>



    <div class="col-10"> <!--class에서 col-10은 빼면 안됨-->
      <div class="container">
        <div class="row">
          <div class="col-lg-12">
            <div class="page-content">
              <!-- Featured Games Start -->
              <div class="row">
                <div class="featured-games header-text">
                  <div class="heading-section">

                    <div class="gaming-library">
                      <div class="col-lg-12">
                        <div class="row">
                          <div class="col">
                            <h4>게임 콘텐츠</h4>
                          </div>
                          <div class="col">
                            <div class="input-group">
                              <input type="text" class="form-control form-control-sm" id="searchText" placeholder="게임명을 검색해주세요" th:value="${searchText}">
                              <button class="btn btn-warning" type="button" onclick="searchGames()">검색</button>
                            </div>
                          </div>
                        </div>
                        <form id="nadopayment" class="my-2" th:action="@{|/payments/paymentsform|}" method="post">
                          <div class="card-deck">
                            <div th:each="game : ${gamePage.content}" class="card mb-3" style="height: 200px;">
                              <div class="row g-0">
                                <div class="col-md-4" style="height: 200px;">
                                  <img th:if="${game != null and game.gameContentFilesList != null and not #lists.isEmpty(game.gameContentFilesList)}"
                                       th:src="@{|/upload/game/${game.gameContentFilesList[0].copyFileName}|}"
                                       alt="게임 이미지" class="card-img" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <div class="col-md-8">
                                  <div class="card-body d-flex justify-content-between align-items-center">
                                    <div class="col-lg-10">
                                      <h5 class="nado-card-title" th:text="${game.gameName}"></h5>
                                        <p class="card-text" id="gameList">
                                          <span th:switch="${game.difficulty}">
                                            <span th:case="'beginner'" class="badge bg-success" >초급</span>
                                            <span th:case="'intermediate'" class="badge bg-warning text-dark">중급</span>
                                            <span th:case="'advanced'" class="badge bg-danger">고급</span>
                                          </span>
                                        </p>
                                      <p class="card-text"><strong>구독기간:</strong> <span th:text="${game.subscriptionDuration} + '일'"></span></p>
                                      <p class="card-text"><strong>구독가능인원:</strong> <span th:text="${game.maxSubscribers} + '명'"></span></p>
                                      <p class="card-text"><strong>포함된 교육자료:</strong>
                                        <span th:if="${#lists.size(game.educationalResourcesList) > 0}">
                                            <span th:each="resource, iterStat : ${game.educationalResourcesList}">
                                                <span th:text="${resource.resourceName}"></span>
                                                <span th:if="${!iterStat.last}">, </span>
                                            </span>
                                        </span>
                                        <span th:unless="${#lists.size(game.educationalResourcesList) > 0}">없음</span>
                                      </p>
                                      <p class="card-text"><strong>판매가:</strong> <span id="nado-salePrice" th:text="${game.salePrice}"></span></p>
                                      <span th:text="${#strings.length(game.packageDetails) > 30 ? #strings.substring(game.packageDetails, 0, 30) + '...' : game.packageDetails}"
                                            data-toggle="popover" data-content="${game.packageDetails}"
                                            data-placement="top"
                                            data-trigger="hover">
                                        </span>
                                    </div>
                                    <div>
                                      <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" name="gameContentNo" id="checkbox1" th:value="${game.gameContentNo}" data-game-content-no="${game.gameContentNo}">
                                        <input type="hidden" id="hiddenGameContentNos" name="gameContentNos" th:value="${gameContentNos}">
                                        <label class="form-check-label" for="checkbox1"></label>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          <!-- 페이지 네이션 처리 -->
                          <div id="pagination">
                            <nav aria-label="Page navigation example">
                              <ul class="pagination justify-content-center">
                                <!-- 이전 페이지 링크 -->
                                <li class="page-item" th:classappend="${gamePage.pageable.pageNumber == 0} ? 'disabled'">
                                  <a class="page-link" href="#" th:href="@{/game/alllist(page=${gamePage.pageable.pageNumber - 1}, searchText=${searchText})}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                  </a>
                                </li>
                                <!-- 페이지 번호 링크 -->
                                <li class="page-item" th:classappend="${i - 1 == gamePage.pageable.pageNumber} ? 'disabled'" th:each="i : ${#numbers.sequence(startPage, endPage)}">
                                  <a class="page-link" href="#" th:href="@{/game/alllist(page=${i - 1}, searchText=${searchText})}" th:text="${i}"></a>
                                </li>
                                <!-- 다음 페이지 링크 -->
                                <li class="page-item" th:classappend="${gamePage.totalPages == gamePage.pageable.pageNumber + 1} ? 'disabled'">
                                  <a class="page-link" href="#" th:href="@{/game/alllist(page=${gamePage.pageable.pageNumber + 1}, searchText=${searchText})}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                  </a>
                                </li>
                              </ul>
                            </nav>
                          </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="navbar navbar-expand-lg navbar-light bg-light fixed-bottom" style="border-radius: 10px; width: 67%; height: 60px; margin-top: 0px; margin-right: 300px !important; margin-bottom: 0px; text-align: center; margin-left: 350px !important;">
                  <div class="container">
                    <div class="d-flex justify-content-between align-items-center">
        <span>
            <img src="/image/game/icon-cart.png" style="width: 30px !important;">
            <span style="margin-right: 20px;">총: <span id="totalItems">0</span> 건</span>
            <span style="margin-left: 30px !important;">합계: <span id="totalPrice">원</span></span>
          <!-- HTML 코드 내에 버튼 추가 -->
          </span>
                    </div>
                    <span>
          <button type="submit" class="btn btn-outline-warning" id="subscribeButton" onclick="subscribe()">구독하기</button>
        </span>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<script>
  // 체크박스 선택 이벤트 핸들러 함수
function handleCheckboxChange(checkbox) {
    // 부모 요소인 카드 (card) 엘리먼트를 찾습니다.
    var card = checkbox.closest(".card");

    // Sale Price를 나타내는 엘리먼트를 찾습니다.
    var salePriceElement = card.querySelector("#nado-salePrice");

    // Sale Price 텍스트를 가져옵니다.
    var formattedPrice = salePriceElement.textContent;

    // 콤마(,)를 제거한 뒤 숫자로 변환
    var salePrice = parseFloat(formattedPrice.replace(/,/g, ''));

    // 여기에 선택된 체크박스에 대한 작업을 수행합니다.
    // 예를 들어, total 합계를 업데이트하거나 다른 작업을 수행할 수 있습니다.

    // 선택된 게임 콘텐츠의 Sale Price 값을 사용하여 작업을 수행합니다.
}

// 모든 체크박스를 찾아 이벤트 핸들러 함수를 연결
var checkboxes = document.querySelectorAll('input[type="checkbox"]');
checkboxes.forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
        handleCheckboxChange(checkbox);
    });
});


  // 반복문을 사용하여 판매가를 콤마로 포맷팅
  document.querySelectorAll('.card').forEach(function(card) {
    var salePriceElement = card.querySelector("#nado-salePrice");
    var salePrice = parseFloat(salePriceElement.textContent);

    // 숫자를 콤마로 포맷팅
    var formattedSalePrice = formatNumberWithCommas(salePrice);

    // <span> 요소에 콤마가 있는 형식으로 설정
    salePriceElement.textContent = formattedSalePrice;
  });

  function formatNumberWithCommas(number) {
    return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }


    // 합계와 선택된 게임 콘텐츠를 초기화합니다.
  var total = JSON.parse(sessionStorage.getItem("totalPrice")) || 0; // 이전 페이지의 합계를 로드하거나 0으로 초기화

  checkboxes.forEach(function (checkbox) {
      checkbox.addEventListener('change', function () {
          var salePrice = parseFloat(checkbox.closest(".card").querySelector("#nado-salePrice").textContent);




  console.log('total0',total)
          // 체크 박스가 선택된 경우
          if (checkbox.checked) {
              var gameContentNo = checkbox.value;
              total += salePrice;
              console.log('total1',total)
               console.log('salePrice1',salePrice)

              // 선택된 게임 콘텐츠 번호와 salePrice를 배열에 추가하고 세션 스토리지에 저장
              if (!selectedGameContentNos.includes(gameContentNo)) {
                  selectedGameContentNos.push(gameContentNo);
                  selectedSalePrices.push(salePrice);
                  sessionStorage.setItem("selectedGameContentNos", JSON.stringify(selectedGameContentNos));
                  sessionStorage.setItem("selectedSalePrices", JSON.stringify(selectedSalePrices));
              }
          } else {
              var gameContentNo = checkbox.value;
              total -= salePrice;

              // 선택 해제된 게임 콘텐츠 번호와 salePrice를 배열에서 제거하고 세션 스토리지를 업데이트
              selectedGameContentNos = selectedGameContentNos.filter(function (value) {
                  return value !== gameContentNo;
              });

              var salePriceIndex = selectedGameContentNos.indexOf(gameContentNo);
              if (salePriceIndex !== -1) {
                  selectedSalePrices.splice(salePriceIndex, 1);
              }

              sessionStorage.setItem("selectedGameContentNos", JSON.stringify(selectedGameContentNos));
              sessionStorage.setItem("selectedSalePrices", JSON.stringify(selectedSalePrices));
          }

          // 합계를 HTML 요소에 업데이트
          if (totalPriceElement) {
              totalPriceElement.innerText = total + " 원";
              sessionStorage.setItem("totalPrice", JSON.stringify(total));
          }
      });
  });
</script>

  <script>
    // !!----------- 체크 박스 선택할 때 발생되는 이벤트
    var checkboxes = document.querySelectorAll('input[type="checkbox"]');
    var selectedGameContentNos = JSON.parse(sessionStorage.getItem("selectedGameContentNos")) || [];  // 게임 번호
    var selectedSalePrices = JSON.parse(sessionStorage.getItem("selectedSalePrices")) || []; // salePrice
    var totalPriceElement = document.getElementById("totalPrice"); // 합계를 표시할 요소
    var totalItemsElement = document.getElementById("totalItems");

console.log('selectedSalePrices',selectedSalePrices)

    if (selectedSalePrices && selectedSalePrices.length > 0) {
        var total = selectedSalePrices.reduce(function (acc, price) {
        return acc + price;
        }, 0);
      } else {
           var total = 0;
      }

    checkboxes.forEach(function (checkbox) {
        checkbox.addEventListener('change', function () {
            var salePrice = parseFloat(checkbox.closest(".card").querySelector("#nado-salePrice").textContent);

            // 체크 박스가 선택된 경우
            if (checkbox.checked) {
                var gameContentNo = checkbox.value;
                total += salePrice;

                // 체크박스 상태 변경 후, 선택된 체크박스 수 업데이트
                var selectedCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
                var totalItemsElement = document.getElementById("totalItems");
                totalItemsElement.textContent = selectedGameContentNos.length;


                // 선택된 게임 콘텐츠 번호와 salePrice를 배열에 추가하고 세션 스토리지에 저장
                if (!selectedGameContentNos.includes(gameContentNo)) {
                    selectedGameContentNos.push(gameContentNo);
                    selectedSalePrices.push(salePrice);
                    sessionStorage.setItem("selectedGameContentNos", JSON.stringify(selectedGameContentNos));
                    sessionStorage.setItem("selectedSalePrices", JSON.stringify(selectedSalePrices));

                }
            } else {
                var gameContentNo = checkbox.value;
                total -= salePrice;


                // 선택 해제된 게임 콘텐츠 번호와 salePrice를 배열에서 제거하고 세션 스토리지를 업데이트
                selectedGameContentNos = selectedGameContentNos.filter(function (value) {
                    return value !== gameContentNo;
                });

                var salePriceIndex = selectedGameContentNos.indexOf(gameContentNo);
                if (salePriceIndex !== -1) {
                    selectedSalePrices.splice(salePriceIndex, 1);

                }

                sessionStorage.setItem("selectedGameContentNos", JSON.stringify(selectedGameContentNos));
                sessionStorage.setItem("selectedSalePrices", JSON.stringify(selectedSalePrices));

            }

            // 합계를 HTML 요소에 업데이트
            if (totalPriceElement) {
                totalPriceElement.innerText = total + " 원";
                sessionStorage.setItem("totalPrice", JSON.stringify(total));
            }
        });
    });

    // 페이지 로드 이벤트에 복원 함수를 연결합니다.
    window.addEventListener("load", restoreSelectedItems);

      // 페이지 로드 시 선택된 항목과 salePrice를 복원합니다.
  function restoreSelectedItems() {
  var selectedGameContentNos = JSON.parse(sessionStorage.getItem("selectedGameContentNos")) || [];
  var selectedSalePrices = JSON.parse(sessionStorage.getItem("selectedSalePrices")) || [];

  var totalPriceElement = document.getElementById("totalPrice");
  var totalItemsElement = document.getElementById("totalItems");

  totalPriceElement.innerText = selectedSalePrices + " 원";
  totalItemsElement.textContent = selectedGameContentNos.length;

  if (selectedGameContentNos.length > 0) {
  // 페이지의 체크박스 초기화
  checkboxes.forEach(function (checkbox) {
  if (selectedGameContentNos.includes(checkbox.value)) {
  checkbox.checked = true;
  }
  });

  // 총 합계 계산
  var total = selectedSalePrices.reduce(function (acc, price) {
  return acc + price;
  }, 0);
  console.log('total',total)

  if (totalPriceElement) {
  // 여기에서 초기화를 이전 페이지의 총 가격으로 설정
  totalPriceElement.innerText = total + " 원";
  }
   if (totalItemsElement) {
            totalItemsElement.textContent = selectedGameContentNos.length;
        }
    }
  }

    // !!----------- 결제하기 버튼 누를때 실행
    function subscribe() {
        var checkboxes = document.querySelectorAll('input[type="checkbox"]');
        var selectedGameContentNos = JSON.parse(sessionStorage.getItem("selectedGameContentNos")) || []; // 기존에 저장된 값 또는 빈 배열

        // 숨겨진 필드에 할당
        document.getElementById("hiddenGameContentNos").value = JSON.stringify(selectedGameContentNos);

        // 폼 제출
        document.getElementById("nadopayment").submit();
    }
  </script>

  <!--  !!----------- 페이지네이션시 값을 다시 불러온다.

  window.addEventListener("load", function () {
       var selectedGameContentNos = sessionStorage.getItem("selectedGameContentNos");
       var selectedSalePrices = sessionStorage.getItem("selectedSalePrices");
       var totalPriceElement = document.getElementById("totalPrice"); // 합계를 표시할 요소

       if (selectedGameContentNos) {
           selectedGameContentNos = JSON.parse(selectedGameContentNos);

           // 페이지의 선택된 항목 체크하기
           checkboxes.forEach(function (checkbox) {
               if (selectedGameContentNos.includes(checkbox.value)) {
                   checkbox.checked = true;
               }
           });

           // 총 합계를 계산하기 위한 변수를 만들어야 합니다.
           var total = 0;

           checkboxes.forEach(function (checkbox) {
               if (checkbox.checked) {
                   var salePrice = parseFloat(checkbox.closest(".card").querySelector("#nado-salePrice").textContent);
                   total += salePrice;
               }
           });

           // 합계를 HTML 요소에 업데이트
           if (totalPriceElement) {
               totalPriceElement.innerText = total + " 원";
           }
       }
   });
 </script>-->
 <script>
   function searchGames() {
     var searchText = document.getElementById('searchText').value;
     window.location.href = '/game/alllist?page=0&searchText=' + searchText;  // 페이지를 0으로 초기화하고 검색어를 포함
   }
 </script>
</div>
</html>